<h2>1、创建用于评测 conda 环境</h2> <br><pre><code class="hljs">conda create -n opencompass python=3.10<br>conda activate opencompass<br><br>cd /root<br>git clone -b 0.3.3 https://github.com/open-compass/opencompass<br>cd opencompass<br>pip install -e .<br>pip install -r requirements.txt<br>pip install huggingface_hub==0.25.2<br><br>pip install importlib-metadata</code></pre> <br><h2>2、评测 API 模型</h2> <br><p>        在终端中运行:</p> <br><pre><code class="hljs">export INTERNLM_API_KEY=xxxxxxxxxxxxxxxxxxxxxxx # 填入你申请的 API Key<br><br>cd /root/opencompass/<br>touch opencompass/configs/models/openai/puyu_api.py</code></pre> <br><p>        后打开文件, 贴入以下代码:</p> <br><pre><code class="hljs">import os<br>from opencompass.models import OpenAISDK<br><br><br>internlm_url = 'https://internlm-chat.intern-ai.org.cn/puyu/api/v1/' # 你前面获得的 api 服务地址<br>internlm_api_key = os.getenv('INTERNLM_API_KEY')<br><br>models = [<br>    dict(<br>        # abbr='internlm2.5-latest',<br>        type=OpenAISDK,<br>        path='internlm2.5-latest', # 请求服务时的 model name<br>        # 换成自己申请的APIkey<br>        key=internlm_api_key, # API key<br>        openai_api_base=internlm_url, # 服务地址<br>        rpm_verbose=True, # 是否打印请求速率<br>        query_per_second=0.16, # 服务请求速率<br>        max_out_len=1024, # 最大输出长度<br>        max_seq_len=4096, # 最大输入长度<br>        temperature=0.01, # 生成温度<br>        batch_size=1, # 批处理大小<br>        retry=3, # 重试次数<br>    )<br>]</code></pre> <br><p>        在终端中运行：</p> <br><pre><code class="hljs">cd /root/opencompass/<br>touch opencompass/configs/datasets/demo/demo_cmmlu_chat_gen.py</code></pre> <br><p>        后打开文件, 贴入以下代码:</p> <br><pre><code class="hljs">from mmengine import read_base<br><br>with read_base():<br>    from ..cmmlu.cmmlu_gen_c13365 import cmmlu_datasets<br><br><br># 每个数据集只取前2个样本进行评测<br>for d in cmmlu_datasets:<br>    d['abbr'] = 'demo_' + d['abbr']<br>    d['reader_cfg']['test_range'] = '[0:1]' # 这里每个数据集只取1个样本, 方便快速评测.<br><br></code></pre> <br><p>        完成配置后, 在终端中运行: <code>python run.py --models puyu_api.py --datasets demo_cmmlu_chat_gen.py --debug，得到结果：</code></p> <br><p style="text-align:center"><img alt="" src="https://i-blog.csdnimg.cn/direct/6288d0aa714242068cc69e4a3b3e2504.bmp" /></p> <br><h2><code>3、</code>评测本地模型</h2> <br><p>        安装相关软件包:</p> <br><pre><code class="hljs">cd /root/opencompass<br>conda activate opencompass<br>conda install pytorch==2.3.1 torchvision==0.18.1 torchaudio==2.3.1 pytorch-cuda=12.1 -c pytorch -c nvidia -y<br>apt-get update<br>apt-get install cmake<br>pip install protobuf==4.25.3</code></pre> <br><p>        还需要重装一些 python 库</p> <br><pre><code class="hljs">pip uninstall numpy -y<br>pip install "numpy<2.0.0,>=1.23.4"<br>pip uninstall pandas -y<br>pip install "pandas<2.0.0"<br>pip install onnxscript<br>pip uninstall transformers -y<br>pip install transformers==4.39.0</code></pre> <br><p>        先将数据集下载到本地，加载本地模型进行评测</p> <br><pre><code class="hljs">cp /share/temp/datasets/OpenCompassData-core-20231110.zip /root/opencompass/<br>unzip OpenCompassData-core-20231110.zip<br><br>python tools/list_configs.py internlm ceval</code></pre> <br><p>         打开 opencompass 文件夹下 <code>configs/models/hf_internlm/的 hf_internlm2_5_1_8b_chat.py</code> 文件, 修改如下:</p> <br><pre><code class="hljs">from opencompass.models import HuggingFacewithChatTemplate<br><br>models = [<br>    dict(<br>        type=HuggingFacewithChatTemplate,<br>        abbr='internlm2_5-1_8b-chat-hf',<br>        path='/share/new_models/Shanghai_AI_Laboratory/internlm2_5-1_8b-chat/',<br>        max_out_len=2048,<br>        batch_size=8,<br>        run_cfg=dict(num_gpus=1),<br>    )<br>]<br><br># python run.py --datasets ceval_gen --models hf_internlm2_5_1_8b_chat --debug</code></pre> <br><p>        通过以下命令评测 InternLM2.5-1.8B-Chat 模型在 C-Eval 数据集上的性能：</p> <br><pre><code class="hljs">python run.py --datasets ceval_gen --models hf_internlm2_5_1_8b_chat --debug<br># 如果出现 rouge 导入报错, 请 pip uninstall rouge 之后再次安装 pip install rouge==1.0.1 可解决问题.</code></pre> <br><p>        测试结果：</p> <br><p style="text-align:center"><img alt="" src="https://i-blog.csdnimg.cn/direct/76887528f0a145d49f8c4444aa7982be.bmp" /></p>